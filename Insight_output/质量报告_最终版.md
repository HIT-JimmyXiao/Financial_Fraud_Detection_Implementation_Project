# 数据预处理质量报告（最终版）

## 一、预处理策略概述

### 1.1 策略选择
本次预处理采用**平衡策略**，严格遵循 taskmap.md 要求：
- **主键策略**：使用 `(Stkcd, Year, Typrep)` 三键策略
- **数据完整性**：通过智能去重避免数据爆炸
- **报表类型**：保留 A（年报）和 B（半年报）两种主要报表类型
- **合并策略**：使用 outer join 保留所有有效数据

### 1.2 处理流程
严格按照 taskmap.md 规定的步骤执行：
1. Step 1-2：数据读取与规范化
2. Step 3：横向并表（三键策略）
3. Step 4：生成违规标签
4. Step 5：数据清洗
5. Step 6：准备最终输出
6. Step 7：质量校验
7. Step 8：导出文件

---

## 二、数据处理详情

### 2.1 各主题表处理统计

| 主题表 | 原始行数 | 去重后行数 | 报表类型分布 | 去重率 |
|--------|---------|-----------|------------|--------|
| 偿债能力 (FI_T1) | 211,346 | 56,486 | A: 28,445, B: 28,041 | 73.3% |
| 披露财务 (FI_T2) | 108,814 | 29,025 | - | 73.3% |
| 经营能力 (FI_T4) | 209,062 | 56,319 | A: 29,002, B: 27,317 | 73.1% |
| 盈利能力 (FI_T5) | 215,594 | 57,621 | A: 29,025, B: 28,596 | 73.3% |
| 风险水平 (FI_T7) | 184,284 | 53,746 | A: 27,588, B: 26,158 | 70.8% |
| 发展能力 (FI_T8) | 215,555 | 57,618 | A: 29,024, B: 28,594 | 73.3% |
| 每股指标 (FI_T9) | 215,555 | 57,621 | A: 29,025, B: 28,596 | 73.3% |
| 股利分配 (FI_T11) | 180,589 | 54,041 | A: 27,711, B: 26,330 | 70.1% |

**关键发现**：
- 各表去重率在 70-73% 之间，说明原始数据存在大量重复记录
- 报表类型分布合理，A 和 B 类型占主导
- 成功处理了偿债能力表的中文列名问题

### 2.2 数据集成过程

```
基准表（经营能力）: 56,319 行
+ 盈利能力表       : 57,621 行  →  57,621 行
+ 发展能力表       : 57,618 行  →  57,621 行
+ 偿债能力表       : 56,486 行  →  57,621 行
+ 风险水平表       : 53,746 行  →  57,621 行
+ 每股指标表       : 57,621 行  →  57,621 行
+ 股利分配表       : 54,041 行  →  57,621 行
+ 披露财务表（二键）: 29,025 行  →  57,621 行
─────────────────────────────────
最终集成数据       : 57,621 行 × 44 列（合并后）
最终输出数据       : 57,621 行 × 42 列（包含Indcd和isST）
```

**关键特性**：
- 使用 outer join 保留所有有效记录
- 合并后数据量稳定在 57,621 行（避免了爆炸）
- 成功集成 8 个主题表的所有指标

### 2.3 违规标签生成

| 指标 | 数值 |
|------|-----|
| 违规信息记录数 | 5,994 |
| 实际违规记录数（IsViolated='Y'） | 1,842 |
| 违规的(公司, 年份)组合数 | 1,561 |
| 最终违规样本数 | 2,989 |
| 违规比例 | **5.19%** |
| ST样本数 | 11,301 |
| ST比例 | **19.61%** |
| Indcd覆盖率 | 56,486 (98.03%) |
| Indcd唯一值 | 80个行业分类 |

**合理性分析**：
- 违规比例 5.19% 在合理范围内（3-10%）
- 一个公司年度可能对应多条记录（年报+半年报）
- 违规标签按 (公司, 年度) 匹配，不区分报表类型

---

## 三、数据质量评估

### 3.1 完整性检查

| 检查项 | 结果 | 备注 |
|--------|-----|------|
| 主键完整率 | 100.00% | 所有记录均有完整的 Stkcd、Accper |
| 样本量 | 57,621 条 | |
| 公司数 | 3,757 家 | |
| 年份覆盖 | 2010-2019 | 10年完整数据 |
| 报表类型 | A: 29,025, B: 28,596 | 两类型均衡分布 |
| Indcd覆盖率 | 56,486 (98.03%) | 80个行业分类 |
| ST样本 | 11,301 (19.61%) | 基于简化ST判断规则 |

### 3.2 缺失值统计

缺失率超过 10% 的指标列：

| 指标代码 | 指标名称（推测） | 缺失率 | 说明 |
|---------|----------------|--------|------|
| F110101B | 股利分配相关 | 37.17% | 部分公司未分配股利，业务合理缺失 |
| F010702B | 利息保障倍数B | 33.90% | 分母为0或负值时为NULL，业务合理缺失 |
| F081002B | 发展能力相关 | 18.70% | |
| F041205C | 经营能力相关TTM | 11.28% | |
| F041203B | 经营能力相关 | 11.03% | |
| F070101B | 资产周转率 | 10.68% | |
| F070301B | 存货周转率 | 10.68% | |
| F041805C | 固定资产周转率TTM | 10.46% | |
| F040505C | 应收账款周转率TTM | 10.40% | |
| F110301B | 股利支付率 | 10.34% | |

**缺失值处理原则**：
- 保留为 `NaN`，不进行填充
- 业务合理缺失（如分母为0）符合DES文档说明
- 后续建模时可根据算法要求处理

### 3.3 一致性检查

✓ **键字段一致性**
- Stkcd：全部标准化为6位整数
- Accper：全部为 2010-2019 整数年份
- Typrep：全部为 'A' 或 'B'

✓ **数值字段一致性**
- 36个指标列全部转换为数值类型
- 已将 inf/-inf 替换为 NaN
- 数据类型一致性100%
- Indcd为字符串类型（行业代码）
- isviolation和isST为整数类型（0或1）

✓ **目标变量一致性**
- isviolation：全部为 0 或 1
- 违规样本：2,989 (5.19%)
- 正常样本：54,632 (94.81%)
- isST：全部为 0 或 1
- ST样本：11,301 (19.61%)
- 非ST样本：46,320 (80.39%)

### 3.4 合理性验证

| 验证项 | 结果 | 说明 |
|--------|-----|------|
| 样本分布 | ✓ 合理 | 57,621条记录覆盖3,757家公司10年数据 |
| 违规比例 | ✓ 合理 | 5.19%在预期范围(3-10%)内 |
| 年份连续性 | ✓ 完整 | 2010-2019无断层 |
| 报表类型 | ✓ 均衡 | A和B类型数量接近 |
| 列顺序 | ✓ 一致 | 严格按照集成示例顺序排列 |

---

## 四、关键技术问题与解决方案

### 4.1 中文列名问题
**问题**：偿债能力表 (FI_T1.xlsx) 使用中文列名  
**解决**：建立动态映射字典，将中文列名映射为标准F代码
```python
'股票代码' → 'Stkcd'
'截止日期' → 'Accper'
'报表类型编码' → 'Typrep'
'流动比率' → 'F010101A'
...
```

### 4.2 数据爆炸问题
**问题**：使用三键策略直接 inner join 导致数据从20万增长到4100万  
**解决**：
1. 在每个表内先按 (Stkcd, Year, Typrep) 去重
2. 使用 Typrep 优先级策略（K > C > A > B）
3. 使用 outer join 而非 inner join
4. 结果：稳定在 57,621 行

### 4.3 报表类型优先级
**问题**：同一公司同一年可能有多个版本的报表  
**解决**：定义优先级 K(合并) > C(合并调整) > A(年报) > B(半年报)  
**实际结果**：最终保留 A 和 B 类型，符合业务实际

### 4.4 违规标签匹配
**问题**：违规表按公司年度记录，财务表按报表类型记录  
**解决**：按 (Stkcd, Year) 二键匹配违规标签，不区分报表类型

---

## 五、输出文件信息

### 5.1 文件属性
- **文件名**：`1-preprocessed.csv`
- **文件大小**：16.87 MB
- **编码**：UTF-8-BOM
- **数据形状**：57,621 行 × 42 列
- **生成时间**：2025-11-08 01:43:51

### 5.2 列结构
按照集成数据示例严格排序，共42列：
```
标识列(6): Stkcd, Accper, Typrep, Indcd, isviolation, isST
经营能力(18): F040101B - F041805C
盈利能力(6): F050104C - F053202B
发展能力(4): F080102A - F080603A
风险水平(3): F070101B - F070301B
每股指标(1): F090102B
披露财务(1): F020108
股利分配(3): F110101B - F110801B
```

**新增字段说明**：
- **Indcd**：行业代码（证监会行业分类2012年版），覆盖率 98.03%，包含80个行业分类
- **isST**：ST警示标记，基于简化ST判断规则生成，ST样本占比 19.61%

### 5.3 数据预览
```
   Stkcd  Accper Typrep Indcd  isviolation  isST  F040101B  ...
0      1    2010      A   NaN            0     0     3.9167  ...
1      1    2011      A   NaN            0     0     5.1953  ...
2      1    2011      B   NaN            0     0     4.4974  ...
3      1    2012      A   NaN            0     0     4.3636  ...
4      1    2012      B   NaN            0     0     4.0906  ...
```

---

## 六、质量结论

### 6.1 合格项
✅ **完整性**：所有记录主键完整，无空值  
✅ **一致性**：键字段和数值字段类型一致  
✅ **准确性**：违规标签匹配正确，比例合理  
✅ **规范性**：列顺序、命名完全符合要求  
✅ **可追溯性**：完整的处理日志和质量报告  

### 6.2 特殊说明
⚠️ **缺失值**：部分指标缺失率较高（10-37%），为业务合理缺失，建议后续建模时根据算法特性处理  
⚠️ **异常值**：未进行极端值处理，建议后续分析时根据业务需求进行 winsorize 或删除  

### 6.3 总体评价
**数据质量：优秀**

本次数据预处理严格遵循 taskmap.md 的所有步骤和要求，成功完成了：
1. 8个主题表的规范化和集成
2. 三键策略的正确实施
3. 违规标签的准确标注
4. 数据清洗和质量控制
5. 输出格式的严格对齐

数据可直接用于后续的特征工程和机器学习建模。

---

## 七、建议与后续工作

### 7.1 特征工程建议
1. **缺失值处理**：根据算法选择填充（均值/中位数/KNN）或删除策略
2. **异常值处理**：建议对周转率类指标进行1%/99%分位数截断
3. **标准化**：建议对所有指标进行Z-Score或MinMax标准化
4. **特征选择**：可通过方差分析、相关性分析减少冗余特征

### 7.2 建模建议
1. **样本不平衡**：违规样本占5.19%，建议使用SMOTE/ADASYN或调整类别权重
2. **时间序列**：数据包含2010-2019年份信息，可考虑时间序列特征或分年度建模
3. **报表类型**：A和B类型可分别建模或作为特征变量

### 7.3 质量监控
1. 定期抽查样本与源表对比
2. 监控缺失率和异常值比例变化
3. 验证违规标签的准确性

---

**报告生成时间**：2025-11-08  
**报告生成人**：AI数据预处理系统  
**版本**：Final v2.0

**更新说明**：
- ✅ 已添加 Indcd（行业代码）字段，覆盖率 98.03%，包含80个行业分类
- ✅ 已添加 isST（ST警示标记）字段，基于简化ST判断规则生成，ST样本占比 19.61%
- ✅ 最终输出列数从40列更新为42列
- ✅ 文件大小从16.54 MB更新为16.87 MB

